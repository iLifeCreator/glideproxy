# üöÄ PM2 Process Optimization Guide

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞—é—Ç 3 –ø—Ä–æ—Ü–µ—Å—Å–∞?**

### üìä –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
–ù–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ (2 —è–¥—Ä–∞, 4–ì–ë –û–ó–£) —Ä–∞–±–æ—Ç–∞—é—Ç **3 PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞**, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- **–ò–∑–±—ã—Ç–æ—á–Ω–æ–º—É –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é –ø–∞–º—è—Ç–∏** (~76MB √ó 3 = ~228MB —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–æ–∫—Å–∏)
- **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –∑–∞ —Ä–µ—Å—É—Ä—Å—ã** –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
- **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

### üîç –ü—Ä–∏—á–∏–Ω—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
1. **ecosystem.production.config.js** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `instances: 2` 
2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã** –∑–∞–ø—É—â–µ–Ω—ã –≤—Ä—É—á–Ω—É—é
3. **–°—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã** –Ω–µ –±—ã–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ: –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

### üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
```
–°–µ—Ä–≤–µ—Ä: 2 CPU cores, 4GB RAM
‚îú‚îÄ‚îÄ Enhanced Proxy: 1 –ø—Ä–æ—Ü–µ—Å—Å (~60MB)
‚îú‚îÄ‚îÄ System: ~1GB 
‚îú‚îÄ‚îÄ Other services: ~1GB
‚îî‚îÄ‚îÄ Free memory: ~2GB (—Ä–µ–∑–µ—Ä–≤)
```

### üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1 –ø—Ä–æ—Ü–µ—Å—Å–∞ vs 3 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | 3 –ø—Ä–æ—Ü–µ—Å—Å–∞ | 1 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|------------|-------------------|-----------|
| **–ü–∞–º—è—Ç—å** | ~228MB | ~60MB | **74% —ç–∫–æ–Ω–æ–º–∏—è** |
| **CPU –Ω–∞–≥—Ä—É–∑–∫–∞** | –í—ã—Å–æ–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ | **–°—Ç–∞–±–∏–ª—å–Ω–µ–µ** |
| **–ö—ç—à —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** | –†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –∫—ç—à | –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—ç—à | **3√ó —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ** |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** | –°–ª–æ–∂–Ω–æ–µ | –ü—Ä–æ—Å—Ç–æ–µ | **–õ–µ–≥—á–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å** |

## üõ†Ô∏è **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**

### üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
./optimize-pm2-processes.sh
```

### ‚öôÔ∏è –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. **–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç** –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
2. **–û—á–∏—â–∞–µ—Ç** PM2 –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π  
3. **–ó–∞–ø—É—Å–∫–∞–µ—Ç** 1 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
4. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç** –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
5. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç** —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å endpoints

## üìã **–ù–æ–≤–∞—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

### üéõÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```javascript
{
  instances: 1,                    // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
  max_memory_restart: '2000M',     // 50% –æ—Ç –æ–±—â–µ–π –ø–∞–º—è—Ç–∏
  CACHE_MAX_SIZE: 1000,           // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∫—ç—à
  MAX_SOCKETS: 500,               // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∫–µ—Ç–æ–≤
  max_old_space_size: 1800        // 1.8–ì–ë –ª–∏–º–∏—Ç –¥–ª—è Node.js
}
```

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 list

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏  
pm2 monit

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
pm2 logs enhanced-proxy-single

# –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
curl http://localhost:3000/health/metrics | jq
```

## üî¨ **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**

### üí° –ü–æ—á–µ–º—É 1 –ø—Ä–æ—Ü–µ—Å—Å –ª—É—á—à–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞?

1. **–ü–∞–º—è—Ç—å**: 
   - Node.js –ø—Ä–æ—Ü–µ—Å—Å: ~50-60MB –±–∞–∑–æ–≤–æ
   - 3 –ø—Ä–æ—Ü–µ—Å—Å–∞: ~180MB+ —Ç–æ–ª—å–∫–æ –Ω–∞ –±–∞–∑–æ–≤—ã–µ –Ω—É–∂–¥—ã
   - 1 –ø—Ä–æ—Ü–µ—Å—Å: ~60MB —Å –±–æ–ª—å—à–∏–º –∫—ç—à–µ–º

2. **CPU**: 
   - 2 —è–¥—Ä–∞ –ª—É—á—à–µ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç 1 —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
   - –ú–µ–Ω—å—à–µ context switching –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
   - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ —è–¥—Ä–æ

3. **–ö—ç—à**: 
   - –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π LRU –∫—ç—à –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω
   - –ë–æ–ª—å—à–∏–π hit rate –ø—Ä–∏ —Ç–æ–º –∂–µ –æ–±—ä–µ–º–µ –ø–∞–º—è—Ç–∏
   - –ú–µ–Ω—å—à–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö

4. **–°–µ—Ç—å**: 
   - Connection pooling –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –≤ 1 –ø—Ä–æ—Ü–µ—Å—Å–µ
   - –ú–µ–Ω—å—à–µ –ø–æ—Ä—Ç–æ–≤ –∏ —Å–æ–∫–µ—Ç–æ–≤
   - –õ—É—á—à–µ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏

## üéØ **–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

### ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ü–∞–º—è—Ç—å**: –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ ~170MB (74% —ç–∫–æ–Ω–æ–º–∏—è)
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ú–µ–Ω—å—à–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤  
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –£–ª—É—á—à–µ–Ω–∏–µ hit rate —Å –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫—ç—à–µ–º
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü—Ä–æ—â–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å 1 –ø—Ä–æ—Ü–µ—Å—Å

### üìà –ë–µ–Ω—á–º–∞—Ä–∫–∏
```bash
# –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (3 –ø—Ä–æ—Ü–µ—Å—Å–∞)
Memory usage: ~228MB
Cache hit rate: –†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
Management: –°–ª–æ–∂–Ω–æ–µ

# –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (1 –ø—Ä–æ—Ü–µ—Å—Å)  
Memory usage: ~60MB
Cache hit rate: –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π
Management: –ü—Ä–æ—Å—Ç–æ–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ–µ
```

## üîß **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã**

### üö® –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 restart enhanced-proxy-single

# –í–æ–∑–≤—Ä–∞—Ç –∫ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
pm2 start /home/user/webapp/optimized-proxy/src/enhanced-simple-proxy.js --name fallback-proxy

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
pm2 kill && pm2 start ecosystem.single.config.js --env production
```

### üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 show enhanced-proxy-single | grep "Used Heap Size"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è  
curl -s http://localhost:3000/health/metrics | jq .cacheStats

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
time curl -s http://localhost:3000/ > /dev/null
```

---

## üéâ **–í—ã–≤–æ–¥**

**–î–ª—è —Å–µ—Ä–≤–µ—Ä–∞ —Å 2 —è–¥—Ä–∞–º–∏ –∏ 4–ì–ë –û–ó–£ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º —è–≤–ª—è–µ—Ç—Å—è 1 —Ö–æ—Ä–æ—à–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å** –≤–º–µ—Å—Ç–æ 3 –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏**
- ‚úÖ **–õ—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è** 
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤**

*–ó–∞–ø—É—Å—Ç–∏—Ç–µ `./optimize-pm2-processes.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!*