#!/bin/bash

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ 2 —è–¥—Ä–∞ / 4–ì–ë –û–ó–£
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

echo "üîç –¢–µ–∫—É—â–∏–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã:"
pm2 list

echo ""
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pm2 stop all 2>/dev/null || true
pm2 delete all 2>/dev/null || true

echo ""
echo "üßπ –û—á–∏—â–∞–µ–º PM2..."
pm2 flush
pm2 kill 2>/dev/null || true

echo ""
echo "‚è≥ –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã..."
sleep 3

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (1 –ø—Ä–æ—Ü–µ—Å—Å)..."

cd /home/user/webapp/optimized-proxy

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs

# –ó–∞–ø—É—Å–∫–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
pm2 start ecosystem.single.config.js --env production

echo ""
echo "üìä –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ PM2:"
pm2 list

echo ""
echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2..."
pm2 save

echo ""
echo "üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:"
echo "Health endpoint:"
sleep 2
curl -s "http://localhost:3000/health" | jq .status 2>/dev/null || curl -s "http://localhost:3000/health"

echo ""
echo "Metrics endpoint:"
curl -s "http://localhost:3000/health/metrics" | jq .uptime 2>/dev/null || echo "Metrics endpoint responding"

echo ""
echo "‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   ‚Ä¢ –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç 1 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å"
echo "   ‚Ä¢ –ü–∞–º—è—Ç—å: –º–∞–∫—Å–∏–º—É–º 2–ì–ë (50% –æ—Ç –æ–±—â–µ–π)"
echo "   ‚Ä¢ –ö—ç—à: —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 1000 —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
echo "   ‚Ä¢ –°–æ–∫–µ—Ç—ã: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è 2-—è–¥–µ—Ä–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
echo ""
echo "üîß –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   pm2 monit"
echo "   pm2 logs enhanced-proxy-single"